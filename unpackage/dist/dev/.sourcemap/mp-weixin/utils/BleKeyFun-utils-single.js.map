{"version":3,"file":"BleKeyFun-utils-single.js","sources":["utils/BleKeyFun-utils-single.js"],"sourcesContent":["//获取工具类\r\nimport utils from './byte-util.js'\r\n//系统api\r\nimport appUtil from './app-util.js';\r\n//日志\r\nimport logger from './logger.js';\r\n\r\nvar gWriteService = '';\r\nconst WRITE_SERVICE_SHORTHAND = '6E400001';\r\nvar gReadService = '';\r\nconst READ_SERVICE_SHORTHAND = '6E400001';\r\nvar gWriteCharacteristic = '';\r\nconst WIRTE_CHARACTERISTIC_SHORTHAND = '6E400002';\r\nvar gReadCharacteristic = '';\r\nconst READ_CHARACTERISTIC_SHORTHAND = '6E400003';\r\nvar gReadRandomCharacteristic = '';\r\nconst READRANDOM_CHARACTERISTIC_SHORTHAND = '6E400004';\r\n\r\nvar ReadServiceFixed = '6E400001-B5A3-F393-E0A9-E50E24DCCA9E';\r\nvar WriteServiceFixed = '6E400001-B5A3-F393-E0A9-E50E24DCCA9E';\r\nvar ReadCharacteristicFixed = '6E400003-B5A3-F393-E0A9-E50E24DCCA9E';\r\nvar WriteCharacteristicFixed = '6E400002-B5A3-F393-E0A9-E50E24DCCA9E';\r\nvar ReadRandomCharacteristicFixed = '6E400004-B5A3-F393-E0A9-E50E24DCCA9E';\r\n\r\n//设备号\r\nvar gIdc = '';\r\n//控制密码\r\nvar gPwd = '';\r\n// 当前发送的数据类型\r\nvar gSendType = '';\r\n// 蓝牙状态的回调\r\nvar gBluetoothState;\r\n// 设备返回数据的回调\r\nvar gOnReceiveValue;\r\n//设备idc\r\nvar deviceId = '';\r\n//蓝牙适配器是否可用\r\nvar available = false;\r\n//是否正在搜索\r\nvar discovering = false;\r\n//蓝牙适配器是否已经打开\r\nvar isBLEAdapterOpen = false;\r\n//连接状态\r\nvar connected = false;\r\n//系统，Android IOS\r\nvar systemType = '';\r\n//系统版本\r\nvar systemVersion = '';\r\n\r\n/**\r\n * 蓝牙状态\r\n */\r\nvar DEFAULT_BLUETOOTH_STATE = {\r\n\t//各种错误,可用来关闭dialog\r\n\tBLUETOOTH_ERROR: -2,\r\n\t//连接失败\r\n\tBLUETOOTH_CONNECT_FAILED: -1,\r\n\t//连接成功\r\n\tBLUETOOTH_CONNECT_SUCESS: 0,\r\n\t//蓝牙适配器不可用\r\n\tBLUETOOTH_ADAPTER_UNAVAILABLE: 1,\r\n\t//打开蓝牙扫描失败\r\n\tBLUETOOTH_DEVICES_DISCOVERY_FAILD: 2,\r\n\t//频繁调用\r\n\tBLUETOOTH_SEND_FREQUENTLY: 3,\r\n\t//开始调用senddata发送数据,可以用来显示dialog\r\n\tBLUETOOTH_PRE_EXECUTE: 4,\r\n\t//没有扫到设备\r\n\tBLUETOOTH_NOT_FOUND: 5,\r\n\t//不支持BLE\r\n\tBLUETOOTH_UNSUPPORTED: 6,\r\n\t//发送失败\r\n\tBLUETOOTH_SEND_FAILED: 7,\r\n\t//无响应\r\n\tBLUETOOTH_NO_RESPONSE: 8\r\n};\r\n\r\n/*---------------------------------------------------------------*/\r\n/*---------------------------通用方法-----------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\nfunction getBLEDataTime() {\r\n\tconst date = new Date();\r\n\tconst MM = `${String(date.getMonth() + 1).padStart(2, '0')}`;\r\n\tconst dd = `${String(date.getDate()).padStart(2, '0')}`;\r\n\tconst hh = `${String(date.getHours()).padStart(2, '0')}`;\r\n\tconst mm = `${String(date.getMinutes()).padStart(2, '0')}`;\r\n\tconst ss = `${String(date.getSeconds()).padStart(2, '0')}`;\r\n\tconst ii = `${String(date.getMilliseconds()).padStart(3, '0')}`;\r\n\tconst formatted = MM + '/' + dd + ' ' + hh + ':' + mm + ':' + ss + '.' + ii;\r\n\treturn formatted;\r\n}\r\n\r\n/**\r\n * 返回连接状态\r\n */\r\nfunction getBLEConnectionState() {\r\n\treturn connected;\r\n}\r\n\r\n/**\r\n * 返回连接名称\r\n */\r\nfunction getBLEConnectionID() {\r\n\treturn gIdc;\r\n}\r\n\r\n/**\r\n * 释放数据\r\n */\r\nfunction releaseData() {\r\n\tlogger.e('释放deviceId');\r\n\tdeviceId = '';\r\n}\r\n\r\n/**\r\n * 释放资源\r\n */\r\nfunction releaseBle() {\r\n\tgIdc = '';\r\n\t//判断是否在扫描\r\n\tif (discovering) {\r\n\t\tlogger.e('停止扫描');\r\n\t\tstopScanBle();\r\n\t}\r\n\t//判断是否连接\r\n\tif (connected) {\r\n\t\tlogger.e('断开连接');\r\n\t\tdisConnect();\r\n\t}\r\n\tif (isBLEAdapterOpen) {\r\n\t\tlogger.e('关闭适配器');\r\n\t\tcloseBluetoothAdapter();\r\n\t}\r\n\treleaseData();\r\n\tlogger.e('关闭连接事件监听');\r\n\tuni.offBLEConnectionStateChange();\r\n\tlogger.e('关闭特征变化监听');\r\n\tuni.offBLECharacteristicValueChange();\r\n}\r\n\r\n/**\r\n * 判断是否支持ble\r\n */\r\nfunction isSupportedBLE(isSupported) {\r\n\tconst deviceInfo = uni.getDeviceInfo();\r\n\tvar brand = deviceInfo.brand;\r\n\tvar platform = deviceInfo.platform;\r\n\tvar system = deviceInfo.system;\r\n\tlogger.e('手机型号:' + brand + ',系统信息:' + platform + ',系统版本:' + system);\r\n\tisSupported(true);\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*-----------------------蓝牙适配器相关方法-------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\n/**\r\n * 蓝牙适配器是否可用\r\n */\r\nfunction isBLEAdapterAvailable(onResult) {\r\n\tif (isBLEAdapterOpen) {\r\n\t\t//适配器已经打开\r\n\t\t//获取适配器状态\r\n\t\tif (!available) {\r\n\t\t\tgetBluetoothAdapterState(function(res) {\r\n\t\t\t\tsetBLEAdapterState(res.available, res.discovering);\r\n\t\t\t\tonResult(res.available);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tonResult(available);\r\n\t\t}\r\n\t} else {\r\n\t\t//打开适配器\r\n\t\topenBluetoothAdapter(function(openSuccess) {\r\n\t\t\tif (openSuccess) {\r\n\t\t\t\tgetBluetoothAdapterState(function(res) {\r\n\t\t\t\t\tsetBLEAdapterState(res.available, res.discovering);\r\n\t\t\t\t\tonResult(res.available);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tonResult(openSuccess);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\n/**\r\n * 打开蓝牙适配器\r\n */\r\nfunction openBluetoothAdapter(cOpenBluetoothAdapter) {\r\n\tuni.openBluetoothAdapter({\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tisBLEAdapterOpen = true;\r\n\t\t\tcOpenBluetoothAdapter(true);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tisBLEAdapterOpen = false;\r\n\t\t\tsetBLEAdapterState(false, false);\r\n\t\t\tcOpenBluetoothAdapter(false);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 设置adapter状态\r\n */\r\nfunction setBLEAdapterState(ava, discovery) {\r\n\tavailable = ava;\r\n\tdiscovering = discovery;\r\n}\r\n\r\n/**\r\n * 获取BleAdapter状态\r\n */\r\nfunction getBluetoothAdapterState(onBleAdapterState) {\r\n\tuni.getBluetoothAdapterState({\r\n\t\tsuccess: function(res) {\r\n\t\t\tonBleAdapterState(res);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tonBleAdapterState(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 监听蓝牙适配器状态变化事件\r\n */\r\nfunction onBluetoothAdapterStateChange() {\r\n\tuni.onBluetoothAdapterStateChange(function(res) {\r\n\t\tlogger.e(`adapterState changed, now is`, res);\r\n\t\tsetBLEAdapterState(res.available, res.discovering);\r\n\t});\r\n}\r\n\r\n/**\r\n * 关闭蓝牙模块，使其进入未初始化状态\r\n */\r\nfunction closeBluetoothAdapter() {\r\n\tuni.closeBluetoothAdapter({\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tisBLEAdapterOpen = false;\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*-----------------------蓝牙连接相关方法-------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\n/**\r\n * 开始连接\r\n */\r\nfunction startConnect() {\r\n\tuni.createBLEConnection({\r\n\t\tdeviceId: deviceId,\r\n\t\tsuccess: function(res) {\r\n\t\t\t/**\r\n\t\t\t * 连接成功，后开始获取设备的服务列表\r\n\t\t\t */\r\n\t\t\tgWriteService = '';\r\n\t\t\tgWriteCharacteristic = '';\r\n\t\t\tgReadService = '';\r\n\t\t\tgReadCharacteristic = '';\r\n\t\t\tgetBLEDeviceServices();\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\t//连接失败\r\n\t\t\tconsole.log(res);\r\n\t\t\tgBluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_CONNECT_FAILED);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction startConnectConnected() {\r\n\tgetBLEDeviceServicesConnected();\r\n}\r\n\r\n/**\r\n * 监听低功耗蓝牙连接状态的改变事件，包括开发者主动连接或断开连接，设备丢失，连接异常断开等等\r\n */\r\nfunction onBLEConnectionStateChange() {\r\n\tuni.onBLEConnectionStateChange(function(res) {\r\n\t\tlogger.e(`device ${res.deviceId} state has changed, connected: ${res.connected}`);\r\n\t\tconnected = res.connected;\r\n\t\t\r\n\t\tif (gBluetoothState != undefined) {\r\n\t\t\tif (connected) {\r\n\t\t\t\tgBluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_CONNECT_SUCESS);\r\n\t\t\t} else {\r\n\t\t\t\tgBluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ERROR);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (res.deviceId == deviceId) {\r\n\t\t\tif (res.connected == true) {\r\n\t\t\t\tif (discovering) {\r\n\t\t\t\t\tstopScanBle();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 断开蓝牙连接\r\n */\r\nfunction disConnect() {\r\n\tuni.closeBLEConnection({\r\n\t\tdeviceId: deviceId,\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tconnected = false;\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*-----------------------蓝牙搜索相关方法-------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\n/**\r\n * 开始搜索\r\n */\r\nfunction startBluetoothDevicesDiscovery() {\r\n\t//开始搜索\r\n\tuni.startBluetoothDevicesDiscovery({\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tdiscovering = res.isDiscovering;\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tdiscovering = res.isDiscovering;\r\n\t\t\tgBluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ERROR);\r\n\t\t\tgBluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_DEVICES_DISCOVERY_FAILD);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 监听寻找到新设备的事件\r\n */\r\nfunction onBluetoothDeviceFound() {\r\n\tuni.onBluetoothDeviceFound(function(devices) {\r\n\t\tif (devices.devices[0].name != '') {\r\n\t\t\tlogger.e('device found:' + devices.devices[0].name);\r\n\t\t}\r\n\t\tif (gIdc == devices.devices[0].localName) {\r\n\t\t\tconsole.log(devices);\r\n\t\t\tdeviceId = devices.devices[0].deviceId;\r\n\t\t\tsaveBLEDeviceInfo(gIdc);\r\n\t\t\tonBLEConnectionStateChange()\r\n\t\t\tonBluetoothAdapterStateChange();\r\n\t\t\tonBLECharacteristicValueChange();\r\n\t\t\tstartConnect(gPwd, gSendType, gBluetoothState, gOnReceiveValue);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction onBluetoothDeviceFoundConnected() {\r\n\tonBluetoothAdapterStateChange();\r\n\tonBLECharacteristicValueChangeConnected();\r\n\tstartConnectConnected(gPwd, gSendType, gBluetoothState, gOnReceiveValue);\r\n}\r\n\r\n/**\r\n * 停止蓝牙扫描\r\n */\r\nfunction stopScanBle() {\r\n\tuni.stopBluetoothDevicesDiscovery({\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tdiscovering = false;\r\n\t\t\tlogger.e('stopScanBle-true discovering:' + discovering);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tdiscovering = false;\r\n\t\t\tlogger.e('stopScanBle-false discovering:' + discovering);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*---------------------蓝牙服务和特征相关方法-----------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\n/**\r\n * 获取设备的服务列表\r\n */\r\nfunction getBLEDeviceServices() {\r\n\tuni.getBLEDeviceServices({\r\n\t\tdeviceId: deviceId,\r\n\t\tsuccess: function(res) {\r\n\t\t\tfor (var i = 0; i < res.services.length; i++) {\r\n\t\t\t\tconsole.log(res);\r\n\t\t\t\tif (res.services[i].uuid.indexOf(WRITE_SERVICE_SHORTHAND) != -1) {\r\n\t\t\t\t\tgWriteService = res.services[i].uuid;\r\n\t\t\t\t}\r\n\t\t\t\tif (res.services[i].uuid.indexOf(READ_SERVICE_SHORTHAND) != -1) {\r\n\t\t\t\t\tgReadService = res.services[i].uuid;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlogger.e('device设备的读服务id:', gWriteService);\r\n\t\t\tlogger.e('device设备的写服务id:', gReadService);\r\n\t\t\tif (gWriteService != '' && gReadService != '' && (gWriteCharacteristic == '' ||\r\n\t\t\t\t\tgReadCharacteristic == '')) {\r\n\t\t\t\tgetBLEDeviceWriteCharacteristics();\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction getBLEDeviceServicesConnected() {\r\n\tuni.getBLEDeviceServices({\r\n\t\tdeviceId: deviceId,\r\n\t\tsuccess: function(res) {\r\n\t\t\tlogger.e('device设备的读服务id:', WriteServiceFixed);\r\n\t\t\tlogger.e('device设备的写服务id:', ReadServiceFixed);\r\n\t\t\tgetBLEDeviceWriteCharacteristicsConnected();\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 获取蓝牙设备某个服务中的所有 characteristic（特征值）\r\n */\r\nfunction getBLEDeviceReadCharacteristics() {\r\n\tuni.getBLEDeviceCharacteristics({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: gReadService,\r\n\t\tsuccess: function(res) {\r\n\t\t\tfor (var i = 0; i < res.characteristics.length; i++) {\r\n\t\t\t\tif (res.characteristics[i].uuid.indexOf(READ_CHARACTERISTIC_SHORTHAND) != -1) {\r\n\t\t\t\t\tgReadCharacteristic = res.characteristics[i].uuid;\r\n\t\t\t\t}\r\n\t\t\t\tif (res.characteristics[i].uuid.indexOf(READRANDOM_CHARACTERISTIC_SHORTHAND) != -1) {\r\n\t\t\t\t\tgReadRandomCharacteristic = res.characteristics[i].uuid;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlogger.e('device设备的读特征值id:' + gReadCharacteristic);\r\n\t\t\tlogger.e('device设备的读Random特征值id:' + gReadRandomCharacteristic);\r\n\t\t\tif (gReadCharacteristic != '') {\r\n\t\t\t\tnotifyBLECharacteristicValueChange();\r\n\t\t\t}\r\n\t\t\tif (gReadRandomCharacteristic != '') {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\treadBLECharacteristicValue();\r\n\t\t\t\t}, 100)\r\n\t\t\t}\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction getBLEDeviceReadCharacteristicsConnected() {\r\n\tuni.getBLEDeviceCharacteristics({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: ReadServiceFixed,\r\n\t\tsuccess: function(res) {\r\n\t\t\tlogger.e('device设备的读特征值id:' + ReadCharacteristicFixed);\r\n\t\t\tlogger.e('device设备的读Random特征值id:' + ReadRandomCharacteristicFixed);\r\n\t\t\tnotifyBLECharacteristicValueChangeConnected();\r\n\t\t\treadBLECharacteristicValueConnected();\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 启用低功耗蓝牙设备特征值变化时的 notify 功能，订阅特征值\r\n */\r\nfunction notifyBLECharacteristicValueChange() {\r\n\tuni.notifyBLECharacteristicValueChange({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: gReadService,\r\n\t\tcharacteristicId: gReadCharacteristic,\r\n\t\tstate: true,\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tappUtil.getSystemInfoComplete(\r\n\t\t\t\tfunction(res) {\r\n\t\t\t\t\tvar system = res.system;\r\n\t\t\t\t\tvar blankIndex = system.indexOf(' ');\r\n\t\t\t\t\tvar pointIndex = system.indexOf('.');\r\n\t\t\t\t\tif (blankIndex != -1 && pointIndex != -1) {\r\n\t\t\t\t\t\tsystemType = system.substring(0, blankIndex);\r\n\t\t\t\t\t\tsystemVersion = system.substring(blankIndex + 1, pointIndex + 2);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tfunction() {\r\n\t\t\t\t\tuni.setBLEMTU({\r\n\t\t\t\t\t\tdeviceId: deviceId,\r\n\t\t\t\t\t\tmtu: 240,\r\n\t\t\t\t\t\tsuccess: function(res) {\r\n\t\t\t\t\t\t\tconsole.log('MTU modify success');\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: function(res) {\r\n\t\t\t\t\t\t\tconsole.log('MTU modify fail');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t);\r\n\t\t},\r\n\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction notifyBLECharacteristicValueChangeConnected() {\r\n\tuni.notifyBLECharacteristicValueChange({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: ReadServiceFixed,\r\n\t\tcharacteristicId: ReadCharacteristicFixed,\r\n\t\tstate: true,\r\n\t\tsuccess: function(res) {\r\n\t\t\tappUtil.getSystemInfoComplete(\r\n\t\t\t\tfunction(res) {\r\n\t\t\t\t\tvar system = res.system;\r\n\t\t\t\t\tvar blankIndex = system.indexOf(' ');\r\n\t\t\t\t\tvar pointIndex = system.indexOf('.');\r\n\t\t\t\t\tif (blankIndex != -1 && pointIndex != -1) {\r\n\t\t\t\t\t\tsystemType = system.substring(0, blankIndex);\r\n\t\t\t\t\t\tsystemVersion = system.substring(blankIndex + 1, pointIndex + 2);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tfunction() {\r\n\t\t\t\t\tuni.setBLEMTU({\r\n\t\t\t\t\t\tdeviceId: deviceId,\r\n\t\t\t\t\t\tmtu: 240,\r\n\t\t\t\t\t\tsuccess: function(res) {\r\n\t\t\t\t\t\t\tconsole.log('MTU modify success');\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: function(res) {\r\n\t\t\t\t\t\t\tconsole.log('MTU modify fail');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction readBLECharacteristicValue() {\r\n\tuni.readBLECharacteristicValue({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: gReadService,\r\n\t\tcharacteristicId: gReadRandomCharacteristic,\r\n\t\tstate: true,\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction readBLECharacteristicValueConnected() {\r\n\tuni.readBLECharacteristicValue({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: ReadServiceFixed,\r\n\t\tcharacteristicId: ReadRandomCharacteristicFixed,\r\n\t\tstate: true,\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 获取写的特征值\r\n */\r\nfunction getBLEDeviceWriteCharacteristics() {\r\n\tuni.getBLEDeviceCharacteristics({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: gWriteService,\r\n\t\tsuccess: function(res) {\r\n\t\t\tfor (var j = 0; j < res.characteristics.length; j++) {\r\n\t\t\t\tif (res.characteristics[j].uuid.indexOf(WIRTE_CHARACTERISTIC_SHORTHAND) != -1) {\r\n\t\t\t\t\tgWriteCharacteristic = res.characteristics[j].uuid;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlogger.e('device设备的写特征值id:' + gWriteCharacteristic);\r\n\t\t\tif (gReadCharacteristic == '') {\r\n\t\t\t\tgetBLEDeviceReadCharacteristics();\r\n\t\t\t}\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction getBLEDeviceWriteCharacteristicsConnected() {\r\n\tuni.getBLEDeviceCharacteristics({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: WriteServiceFixed,\r\n\t\tsuccess: function(res) {\r\n\t\t\tlogger.e('device设备的写特征值id:' + WriteCharacteristicFixed);\r\n\t\t\tgetBLEDeviceReadCharacteristicsConnected();\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 获取设备发过来的数据\r\n */\r\nfunction onBLECharacteristicValueChange() {\r\n\tuni.onBLECharacteristicValueChange(function(characteristic) {\r\n\t\tvar resultArrayBufferData = characteristic.value;\r\n\t\tvar receiverHexData = utils.buf2hex(resultArrayBufferData);\r\n\t\tvar arrayData = utils.hexStringToArray(receiverHexData);\r\n\t\tconst formatted = getBLEDataTime();\r\n\t\t\r\n\t\tif (characteristic.characteristicId.indexOf(READRANDOM_CHARACTERISTIC_SHORTHAND) != -1) {\r\n\t\t\tconsole.log('随机指令接收:' + formatted + '  数据:' + receiverHexData);\r\n\t\t\tlogger.e('随机指令数据:' + receiverHexData, false, false, true);\r\n\t\t\tgOnReceiveValue(0, arrayData, utils.hexCharCodeToStr(receiverHexData), receiverHexData);\r\n\t\t} else {\r\n\t\t\tconsole.log('通知指令接收:' + formatted + '  数据:' + receiverHexData);\r\n\t\t\tlogger.e('通知指令接收:' + receiverHexData, false, false, true);\r\n\t\t\tgOnReceiveValue(1, arrayData, utils.hexCharCodeToStr(receiverHexData), receiverHexData);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction onBLECharacteristicValueChangeConnected() {\r\n\tuni.onBLECharacteristicValueChange(function(characteristic) {\r\n\t\tvar resultArrayBufferData = characteristic.value;\r\n\t\tvar receiverHexData = utils.buf2hex(resultArrayBufferData);\r\n\t\tvar arrayData = utils.hexStringToArray(receiverHexData);\r\n\t\tconst formatted = getBLEDataTime();\r\n\t\t\r\n\t\tif (characteristic.characteristicId == ReadRandomCharacteristicFixed) {\r\n\t\t\tconsole.log('随机指令接收:' + formatted + '  数据:' + receiverHexData);\r\n\t\t\tlogger.e('随机指令数据:' + receiverHexData, false, false, true);\r\n\t\t\tgOnReceiveValue(0, arrayData, utils.hexCharCodeToStr(receiverHexData), receiverHexData);\r\n\t\t} else {\r\n\t\t\tconsole.log('通知指令接收:' + formatted + '  数据:' + receiverHexData);\r\n\t\t\tlogger.e('通知指令接收:' + receiverHexData, false, false, true);\r\n\t\t\tgOnReceiveValue(1, arrayData, utils.hexCharCodeToStr(receiverHexData), receiverHexData);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * 向低功耗蓝牙设备特征值中写入二进制数据\r\n */\r\nfunction writeBLECharacteristicValue(buffer, writeBLECharacteristicValue) {\r\n\tuni.writeBLECharacteristicValue({\r\n\t\tdeviceId: deviceId,\r\n\t\tserviceId: WriteServiceFixed,\r\n\t\tcharacteristicId: WriteCharacteristicFixed,\r\n\t\tvalue: buffer,\r\n\t\tsuccess: function(res) {\r\n\t\t\twriteBLECharacteristicValue(true);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\twriteBLECharacteristicValue(false);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*------------------------初始化数据方法--------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\n/**\r\n * 初始化数据\r\n */\r\nfunction initSendData(idc, pwd, sendType, bluetoothState, onReceiveValue) {\r\n\tif (gPwd != pwd) {\r\n\t\tgPwd = pwd;\r\n\t}\r\n\tif (gSendType != sendType) {\r\n\t\tgSendType = sendType;\r\n\t}\r\n\tif (gBluetoothState != bluetoothState) {\r\n\t\tgBluetoothState = bluetoothState;\r\n\t}\r\n\tif (gOnReceiveValue != onReceiveValue) {\r\n\t\tgOnReceiveValue = onReceiveValue;\r\n\t}\r\n\tif (gIdc != idc) {\r\n\t\tgIdc = idc;\r\n\t}\r\n\tonBluetoothDeviceFound();\r\n}\r\n\r\nfunction initSendDataConnected(idc, pwd, sendType, bluetoothState, onReceiveValue) {\r\n\tif (gPwd != pwd) {\r\n\t\tgPwd = pwd;\r\n\t}\r\n\tif (gSendType != sendType) {\r\n\t\tgSendType = sendType;\r\n\t}\r\n\tif (gBluetoothState != bluetoothState) {\r\n\t\tgBluetoothState = bluetoothState;\r\n\t}\r\n\tif (gOnReceiveValue != onReceiveValue) {\r\n\t\tgOnReceiveValue = onReceiveValue;\r\n\t}\r\n\tif (gIdc != idc) {\r\n\t\tgIdc = idc;\r\n\t}\r\n\tonBluetoothDeviceFoundConnected();\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*------------------------外部调用起始方法--------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\n/**\r\n * idc:设备名称\r\n * pwd:控制密码\r\n * sendType:发送类型\r\n * bluetoothState:蓝牙状态\r\n * onReceiveValue:接收数据\r\n */\r\nfunction connectBLE(idc, bluetoothState, onReceiveValue) {\r\n\tconnectMyBLE(idc, bluetoothState, onReceiveValue, true);\r\n}\r\n\r\nfunction connectBLEConnected(idc, bluetoothState, onReceiveValue) {\r\n\tconnectMyBLEConnected(idc, bluetoothState, onReceiveValue, true);\r\n}\r\n\r\nfunction connectMyBLE(idc, bluetoothState, onReceiveValue, isIntercept) {\r\n\tif (connected) {\r\n\t\t// 已连接，发送数据\r\n\t} else {\r\n\t\tisSupportedBLE(function(isSupported) {\r\n\t\t\tif (isSupported) {\r\n\t\t\t\tisBLEAdapterAvailable(function(ava) {\r\n\t\t\t\t\tif (ava) {\r\n\t\t\t\t\t\tinitSendData(idc, '', '', bluetoothState, onReceiveValue);\r\n\t\t\t\t\t\tstartBluetoothDevicesDiscovery();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tgBluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ERROR);\r\n\t\t\t\t\t\tgBluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ADAPTER_UNAVAILABLE);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tbluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ERROR);\r\n\t\t\t\tbluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_UNSUPPORTED);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction connectMyBLEConnected(idc, bluetoothState, onReceiveValue, isIntercept) {\r\n\tisSupportedBLE(function(isSupported) {\r\n\t\tif (isSupported) {\r\n\t\t\tisBLEAdapterAvailable(function(ava) {\r\n\t\t\t\tif (ava) {\r\n\t\t\t\t\tinitSendDataConnected(idc, '', '', bluetoothState, onReceiveValue);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ERROR);\r\n\t\t\t\t\tbluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ADAPTER_UNAVAILABLE);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tbluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_ERROR);\r\n\t\t\tbluetoothState(DEFAULT_BLUETOOTH_STATE.BLUETOOTH_UNSUPPORTED);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*------------------------外部调用发送方法--------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\n/**\r\n * 最大每次发送20个字节\r\n * sendData：十六进制字符串\r\n * noRepeat:6001指令不需要应答\r\n */\r\nfunction dispatcherSend2(sendData, noRepeat) {\r\n\tvar data = sendData;\r\n\tdelaySend2(data, noRepeat);\r\n}\r\n\r\n/**\r\n * 延时发送，不要超过150ms\r\n */\r\nfunction delaySend2(data, noRepeat) {\r\n\tvar d = data;\r\n\tsetTimeout(function() {\r\n\t\tsend2(d, noRepeat);\r\n\t}, 10);\r\n}\r\n\r\n/**\r\n * 发送数据\r\n * hex:十六进制字符串\r\n */\r\nfunction send2(hex, noRepeat) {\r\n\tvar buffer = hex;\r\n\twriteBLECharacteristicValue(buffer, function(isSuccess) {\r\n\t\tconst formatted = getBLEDataTime();\r\n\t\tvar sendArrayBufferData = buffer;\r\n\t\tvar sendHexData = utils.buf2hex(sendArrayBufferData);\r\n\r\n\t\tif (isSuccess) {\r\n\t\t\tconsole.log('指令发送成功:' + formatted + '  数据:' + sendHexData);\r\n\t\t\tlogger.e('指令发送成功:' + sendHexData, false, false, true);\r\n\t\t} else {\r\n\t\t\tconsole.log('!!!指令发送失败:' + formatted + '  数据:' + sendHexData);\r\n\t\t\tlogger.e('!!!指令发送失败:' + sendHexData, false, false, true);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/*---------------------------------------------------------------*/\r\n/*------------------------其他内部使用方法--------------------------*/\r\n/*---------------------------------------------------------------*/\r\n\r\nfunction makePair() {\r\n\tuni.makeBluetoothPair({\r\n\t\tdeviceId: deviceId,\r\n\t\ttimeout: 20000,\r\n\t\tsuccess: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t},\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction saveBLEDeviceInfo(deviceIDC) {\r\n\tconsole.log('saveBLEDeviceInfo');\r\n\tvar param = {};\r\n\tparam['deviceId'] = deviceId;\r\n\tparam['readServiceUUID'] = gReadService;\r\n\tparam['writeServiceUUID'] = gWriteService;\r\n\tparam['readCharacUUID'] = gReadCharacteristic;\r\n\tparam['writeCharacUUID'] = gWriteCharacteristic;\r\n\tparam['randomServiceUUID'] = gReadService;\r\n\tparam['randomCharacUUID'] = gReadRandomCharacteristic;\r\n\tvar jparam = JSON.stringify(param);\r\n\tuni.setStorage({\r\n\t\tkey: deviceIDC,\r\n\t\tdata: jparam,\r\n\t\tsuccess: function() {}\r\n\t});\r\n}\r\n\r\nfunction getBLEDeviceInfo(deviceIDC, result) {\r\n\tconsole.log('getBLEDeviceInfo');\r\n\tuni.getStorage({\r\n\t\tkey: deviceIDC,\r\n\t\tsuccess: function(res) {\r\n\t\t\tvar param = JSON.parse(res.data);\r\n\t\t\tdeviceId = param.deviceId;\r\n\t\t\tconsole.log(deviceId);\r\n\t\t\tgReadService = param.readServiceUUID;\r\n\t\t\tconsole.log(gReadService);\r\n\t\t\tgWriteService = param.writeServiceUUID;\r\n\t\t\tconsole.log(gWriteService);\r\n\t\t\tgReadCharacteristic = param.readCharacUUID;\r\n\t\t\tconsole.log(gReadCharacteristic);\r\n\t\t\tgWriteCharacteristic = param.writeCharacUUID;\r\n\t\t\tconsole.log(gWriteCharacteristic);\r\n\t\t\tgReadRandomCharacteristic = param.randomCharacUUID;\r\n\t\t\tconsole.log(gReadRandomCharacteristic);\r\n\t\t\tresult(true, param);\r\n\t\t},\r\n\r\n\t\tfail: function(res) {\r\n\t\t\tconsole.log(res);\r\n\t\t\tresult(false);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction clrBLEDeviceInfo(deviceIDC) {\r\n\tconsole.log('clrBLEDeviceInfo');\r\n\tuni.removeStorage({\r\n\t\tkey: deviceIDC,\r\n\t\tsuccess: function() {}\r\n\t});\r\n}\r\n\r\nexport default {\r\n\tconnectBLE,\r\n\treleaseBle,\r\n\tdispatcherSend2,\r\n\tDEFAULT_BLUETOOTH_STATE,\r\n\tgetBLEConnectionState,\r\n\tgetBLEConnectionID,\r\n\tmakePair,\r\n\tsaveBLEDeviceInfo,\r\n\tgetBLEDeviceInfo,\r\n\tclrBLEDeviceInfo,\r\n\tconnectBLEConnected\r\n};"],"names":["logger","uni","appUtil","res","utils","writeBLECharacteristicValue"],"mappings":"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"}